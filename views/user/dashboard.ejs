<%- include('./partials/user_nav') %>

<div class="container mt-4">
  <h2 class="text-center fw-bold mb-4">Available Boats</h2>

  <div class="row">
    <% boats.forEach(boat => { %>
      <div class="col-md-4 mb-4">
        <div class="card shadow-sm border-0 rounded-4">
          <img src="<%= boat.photo ? '/uploads/' + boat.photo : '/images/default-boat.jpg' %>" class="card-img-top" style="height: 220px; object-fit: cover;">
          <div class="card-body">
            <h5 class="card-title fw-bold"><%= boat.name %></h5>
            <p><strong>Owner:</strong> <%= boat.owner_name %></p>
            <p><strong>Capacity:</strong> <%= boat.capacity %> people</p>
           <a class="btn btn-primary" href="/user/book/<%= boat.id %>">Book</a>

          </div>
        </div>
      </div>
    <% }) %>
  </div>
</div>

<div class="modal fade" id="bookingModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content rounded-4 p-3">
      <div class="modal-header">
        <h5 class="modal-title fw-bold">Select Places</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form action="/user/book" method="POST">
        <div class="modal-body">
          <div class="row" id="place-list"></div>
          <input type="hidden" name="boat_id" id="modal-boat-id">
          <input type="hidden" name="selected_places" id="selected-places">
          <input type="hidden" name="total_price" id="selected-price">
        </div>
        <div class="modal-footer d-flex justify-content-between">
          <h5>Total Price: ₹<span id="price-total">0</span></h5>
          <button type="submit" class="btn btn-success rounded-pill">Confirm Booking</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const placeData =  JSON.stringify(prices) ;
  const allPlaces = JSON.stringify(places) ;
  
  console.log('Prices:', placeData);
  console.log('Places:', allPlaces);

  document.querySelectorAll('.book-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const boatId = btn.dataset.boat;
      document.getElementById('modal-boat-id').value = boatId;

      const filteredPlaces = placeData.filter(p => p.boat_id == boatId);
      const placeList = document.getElementById('place-list');
      placeList.innerHTML = '';

      filteredPlaces.forEach(p => {
        const placeDetails = allPlaces.find(pl => pl.id === p.place_id);
        const div = document.createElement('div');
        div.className = 'col-md-4 mb-3';
        div.innerHTML = `
          <div class="card shadow-sm border-0 h-100">
            <img src="${placeDetails.image}" class="card-img-top" style="height: 160px; object-fit: cover;">
            <div class="card-body">
              <h6 class="card-title">${placeDetails.name}</h6>
              <p>₹${p.price}</p>
              <div class="form-check">
                <input class="form-check-input place-check" type="checkbox" value="${p.place_id}" data-price="${p.price}">
                <label class="form-check-label">Select</label>
              </div>
            </div>
          </div>
        `;
        placeList.appendChild(div);
      });

      document.getElementById('price-total').textContent = 0;
      document.getElementById('selected-places').value = '';
      document.getElementById('selected-price').value = '';

      const modal = new bootstrap.Modal(document.getElementById('bookingModal'));
      modal.show();

      placeList.addEventListener('change', () => {
        const selected = Array.from(document.querySelectorAll('.place-check:checked'));
        const price = selected.reduce((sum, cb) => sum + parseFloat(cb.dataset.price), 0);
        const ids = selected.map(cb => cb.value);
        document.getElementById('price-total').textContent = price;
        document.getElementById('selected-places').value = ids.join(',');
        document.getElementById('selected-price').value = price;
      }, { once: true });
    });
  });
});
</script>
